# Sandbox Security Guidelines

## Overview
The sandbox execution environment is designed to safely run untrusted code generated by the LLM. This document outlines security policies and best practices.

## Security Layers

### 1. Import Restrictions
**Allowed imports** (see `config/sandbox_policy.yaml`):
- Data manipulation: `pandas`, `numpy`
- Visualization: `matplotlib`, `seaborn`
- Utilities: `json`, `csv`, `datetime`, `collections`

**Blocked imports**:
- System access: `os`, `subprocess`, `sys`
- Network: `socket`, `requests`, `urllib`, `http`
- Code execution: `eval`, `exec`, `__import__`, `importlib`

### 2. Resource Limits
- **Timeout**: 30 seconds max execution time
- **Memory**: 512 MB limit
- **CPU**: 50% of one core
- **Output size**: 1 MB max

### 3. Filesystem Access
- **Read-only**: Code can only read from designated data directories
- **No write access**: Cannot modify or create files
- **Blocked paths**: System directories (`/etc`, `/root`, `C:\Windows`)

### 4. Network Isolation
- **No internet access**: All network operations blocked
- **No local connections**: Cannot connect to local services

## Implementation

### Subprocess Mode (Default)
```python
# Uses Python's subprocess module
# Fast, suitable for development
# Limited security (relies on OS permissions)
```

### Docker Mode (Production)
```python
# Full container isolation
# Network disabled, read-only filesystem
# Strong security guarantees
# See docker/README.md for setup
```

## Best Practices

### 1. Code Review Before Execution
Always validate generated code before sandbox execution:
- Check for suspicious patterns
- Verify import statements
- Review file operations

### 2. Monitor Resource Usage
Track execution metrics:
- Execution time
- Memory consumption
- Output size

### 3. Audit Trail
Log all sandbox executions:
- Timestamp
- Code executed
- Result status
- Errors (if any)

### 4. Regular Policy Updates
Review and update `config/sandbox_policy.yaml` regularly:
- Add new allowed libraries as needed
- Tighten restrictions based on observed patterns
- Update resource limits based on usage

## Threat Model

### What the Sandbox Protects Against
✅ File system access (read/write outside sandbox)  
✅ Network operations (data exfiltration)  
✅ Resource exhaustion (CPU, memory bombs)  
✅ Code injection attacks  
✅ Privilege escalation  

### What the Sandbox Does NOT Protect Against
❌ Algorithmic complexity attacks (slow but valid code)  
❌ Logic bugs in generated code  
❌ Incorrect data analysis results  

## Testing

### Security Tests
Run sandbox security tests regularly:
```bash
pytest tests/test_sandbox.py -v
```

Test coverage includes:
- Import restriction enforcement
- Resource limit enforcement
- Timeout handling
- Filesystem isolation

## Incident Response

### If Suspicious Code is Detected
1. **Stop execution** immediately
2. **Save the code** for analysis
3. **Review logs** for patterns
4. **Update policies** to prevent recurrence
5. **Notify team** of the incident

### Monitoring
Monitor for:
- Repeated timeout errors
- Attempts to import blocked modules
- Unusual output patterns
- High resource consumption

## Configuration Reference

See `config/sandbox_policy.yaml` for complete configuration.

Key settings:
```yaml
limits:
  timeout_seconds: 30
  memory_mb: 512
  cpu_percent: 50

blocked:
  imports: [os, subprocess, socket, ...]
  
allowed:
  imports: [pandas, numpy, json, ...]
```

## Updates
This document is updated alongside sandbox implementation changes.

**Last Updated**: January 27, 2026  
**Version**: 1.0.0
